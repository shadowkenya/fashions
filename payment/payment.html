<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Complete Your Payment</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<style>
/* Background */
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: url('img/shop.jpg') no-repeat center center fixed;
  background-size: cover;
  overflow-x: hidden;
  position: relative;
}

/* Effects */
body::before, body::after {
  content: '';
  position: fixed;
  left: 0; right: 0;
  height: 200px;
  background: radial-gradient(circle at 50% 50%, rgba(76,175,80,0.3), transparent 70%);
  animation: moveWaves 6s infinite alternate ease-in-out;
  z-index: 0;
}
body::after {
  bottom: 0;
  background: radial-gradient(circle at 50% 50%, rgba(56,142,60,0.25), transparent 70%);
  animation-delay: 3s;
}
@keyframes moveWaves { from{transform:translateY(0);} to{transform:translateY(20px);} }

/* Card */
.card {
  border-radius: 18px;
  background: #fff;
  max-width: 480px;
  margin: 2rem auto;
  position: relative;
  z-index: 1;
}

/* Popups */
#popup-container {
  position: fixed; top: 1rem; right: 1rem;
  z-index: 9999;
  display: flex; flex-direction: column;
  gap: .5rem;
}
.popup {
  background: #fff;
  border-left: 5px solid #28a745;
  padding: .5rem .75rem;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,.1);
  display: flex; gap: .5rem;
  animation: fadeInOut 5s forwards;
}
@keyframes fadeInOut {
  0% {opacity:0;transform:translateX(100%);}
  10%,90% {opacity:1;transform:translateX(0);}
  100% {opacity:0;transform:translateX(100%);}
}
</style>
</head>

<body>

<div id="popup-container"></div>

<div class="container py-4">
  <div class="card shadow p-4">

    <h4 class="text-center mb-3 text-success">Payment Details</h4>

    <img id="productImg" src="" class="img-fluid rounded mb-3 shadow-sm w-100">
    <h5 id="productName"></h5>
    <p id="productPrice" class="text-success fw-bold"></p>

    <form id="paymentForm">
      <div class="mb-3">
        <label class="form-label">Full Name</label>
        <input type="text" id="fullName" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Phone Number</label>
        <input type="tel" id="phoneNumber" class="form-control" placeholder="07XXXXXXXX" required>
      </div>

      <div class="mb-3">
        <label class="form-label">County</label>
        <input type="text" id="county" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Delivery Date</label>
        <input type="date" id="deliveryDate" class="form-control" required>
      </div>

      <button type="submit" class="btn btn-success w-100 mt-3">Pay Now</button>
      <a href="index.html" class="btn btn-outline-success w-100 mt-2">Return to Home Page</a>
    </form>

  </div>
</div>

<script>
// GET PRODUCT DETAILS
const params = new URLSearchParams(location.search);
document.getElementById('productImg').src = params.get('img');
document.getElementById('productName').textContent = params.get('name');
document.getElementById('productPrice').textContent = "Price: KSH " + params.get('price');

// DELIVERY DATE RESTRICTION
document.getElementById('deliveryDate').min = new Date().toISOString().split('T')[0];

// RANDOM POPUPS
const names = ["Faith","John","Ann","David","Mary","Kevin","Lucy","Brian","Sarah","Peter","Tom"];
function randomPopup() {
  const name = names[Math.floor(Math.random()*names.length)];
  const last = Math.floor(1000 + Math.random()*9000).toString().slice(0,2);
  const popup = document.createElement('div');
  popup.className = 'popup';
  popup.innerHTML = `<i class="fas fa-user-circle text-success"></i> ${name} 2547****${last} purchased now`;
  document.getElementById('popup-container').appendChild(popup);
  setTimeout(()=>popup.remove(),5000);
}
setInterval(randomPopup,8000);
randomPopup();

// STK PUSH REQUEST
document.getElementById('paymentForm').addEventListener('submit', async e => {
  e.preventDefault();

  const name = document.getElementById('fullName').value;
  const phone = document.getElementById('phoneNumber').value.replace(/^0/, "254");
  const amount = params.get('price');
  const reference = "ORD" + Math.floor(Math.random() * 900 + 100);

  document.querySelector('.card').innerHTML = `
      <div class="text-center py-5">
        <div class="spinner-border text-success mb-3"></div>
        <p>Sending STK Push... Check your phone</p>
      </div>`;

  // REAL PAYHERO STK PUSH API
  const response = await fetch("https://payhero.co.ke/api/stk/push", {
    method: "POST",
    headers: {
      "Authorization": "Bearer YOUR_PAYHERO_API_KEY",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      amount: amount,
      msisdn: phone,
      account_no: reference,
      callback_url: "https://yourdomain.com/callback.php"
    })
  });

  const result = await response.json();

  if (result.status === true || result.success === true) {
    alert("STK Push Sent! Enter your M-Pesa PIN on your phone.");
  } else {
    alert("STK Push Failed: " + JSON.stringify(result));
  }
});
</script>
</body>
</html>
